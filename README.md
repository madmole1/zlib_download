# Zlibrary EPUB 搜索工具

基于 Zlibrary API 的 Python 工具，用于搜索和下载 EPUB 格式书籍。

## 功能特性

- 根据书名、作者、出版社多条件搜索书籍
- **优化的智能约束搜索策略**：
  - ✅ 一次性在线搜索获取所有相关书籍
  - ✅ 本地逐步筛选（书名 → 出版社 → 作者）
  - ✅ 智能回退机制
  - ✅ 性能提升约60-70%
- 自动筛选 EPUB 格式的可下载书籍
- 显示书籍详细信息（标题、作者、出版社、年份、文件大小等）
- 支持直接下载书籍到本地
- 显示今日剩余下载次数
- **支持批量搜索**（JSON文件输入）
- **多版本汇总显示**（一本书的多个版本一起展示）
- **搜索策略追踪**：在结果中显示完整的搜索和筛选过程

## 文件说明

- `batch_search.py` - **批量搜索工具（优化版 - 推荐）**（智能约束策略，一次搜索+本地筛选）
- `batch_search_mock_v2.py` - 批量搜索模拟版（优化版，测试智能策略）
- `batch_search_mock_strategy.py` - 批量搜索模拟版（旧版）
- `batch_search_mock.py` - 批量搜索模拟版（用于测试）
- `test_search.py` - 单本搜索测试脚本
- `zlib_search.py` - 交互式搜索工具
- `demo_output.py` - 演示输出格式
- `Zlibrary.py` - Zlibrary API 核心库

## 配置登录信息

### 方法1: 修改代码配置（推荐）

在 `test_search.py` 或 `zlib_search.py` 顶部的配置区域修改：

```python
# ========== 配置区域 ==========
# 邮箱+密码登录
DEFAULT_EMAIL = "your@email.com"
DEFAULT_PASSWORD = "your_password"

# 或者使用Remix Token（更稳定）
DEFAULT_REMIX_USERID = "你的remix_userid"
DEFAULT_REMIX_USERKEY = "你的remix_userkey"
# ===============================
```

### 方法2: 获取Remix Token

1. 在浏览器中登录 [https://1lib.sk](https://1lib.sk)
2. 打开开发者工具 (按 F12 键)
3. 进入 **Application (应用程序)** 标签页
4. 左侧找到 **Cookies** → 选择 `1lib.sk`
5. 找到以下两个cookie值并复制:
   - `remix_userid`
   - `remix_userkey`

## 使用方法

### 批量搜索（推荐）

#### 1. 创建搜索条件文件

创建JSON格式的输入文件（如 `1.txt`）：

```json
[
    {
        "title": "二战全史",
        "author": "白虹",
        "publisher": "中国华侨出版社"
    },
    {
        "title": "Python编程",
        "author": "Eric Matthes",
        "publisher": "人民邮电出版社"
    }
]
```

#### 2. 运行批量搜索

```bash
cd d:/gotest/zlib_download
python batch_search.py 1.txt
```

或指定输出文件名：
```bash
python batch_search.py 1.txt my_results.txt
```

#### 3. 查看结果

结果默认输出到 `list.txt` 文件，包含：
- 已找到的书籍列表（多版本汇总）
- 未找到的书籍列表
- 搜索统计信息

**注意**: `batch_search.py` 需要网络连接到 `1lib.sk`。如果网络连接有问题，可以使用模拟版 `batch_search_mock.py` 进行测试。

### 快速测试

运行测试脚本，搜索《二战全史》：

```bash
cd d:/gotest/zlib_download
python test_search.py
```

### 交互式使用

运行交互式程序，输入搜索条件：

```bash
python zlib_search.py
```

### 编程调用

```python
from Zlibrary import Zlibrary

# 登录
zlib = Zlibrary(email="your@email.com", password="password")
# 或使用Token
# zlib = Zlibrary(remix_userid="12345", remix_userkey="abcdef")

# 搜索书籍
result = zlib.search(
    message="二战全史 白虹 中国华侨出版社",
    extensions="epub",
    limit=10
)

# 获取书籍详情
book = result["books"][0]
book_info = zlib.getBookInfo(book["id"], book["hash"])

# 下载书籍
filename, content = zlib.downloadBook(book)

# 保存文件
with open(filename, "wb") as f:
    f.write(content)
```

## 测试结果示例

### 优化后的智能约束搜索策略

程序使用优化的逐步约束策略，大幅提升搜索速度：

```
步骤1: 一次性在线搜索"书名"
  ↓ 获取所有相关书籍

步骤2: 本地按书名筛选
  ↓ 如果结果>1

步骤3: 本地按出版社筛选
  ↓ 如果结果>1

步骤4: 本地按作者筛选
  ↓ 智能回退机制
```

**性能优势**:
- 旧版: 需要多次在线搜索（3次网络请求）
- 新版: 只需1次在线搜索，其余本地筛选
- **速度提升**: 约60-70%

详细说明见 [OPTIMIZATION.md](OPTIMIZATION.md)

### 批量搜索输出示例（list.txt）

```
====================================================================================================
Zlibrary 批量搜索结果
====================================================================================================
搜索时间: 2026-02-03 11:25:18
总共搜索: 3 本书
找到可下载EPUB: 2 本书
未找到: 1 本书
====================================================================================================

【已找到的书籍列表】
====================================================================================================

────────────────────────────────────────────────────────────────────────────────────────────────────
搜索条件: 书名: Python编程 | 作者: Eric Matthes | 出版社: 人民邮电出版社
────────────────────────────────────────────────────────────────────────────────────────────────────
找到 2 个可下载的EPUB版本:

  【版本 1】
    书名: Python编程：从入门到实践
    作者: Eric Matthes
    出版社: 人民邮电出版社
    年份: 2020
    语言: 中文
    页数: 459
    文件大小: 8.2 MB
    ID: 1234567
    Hash: abc123
  【版本 2】
    书名: Python编程：从入门到实践（第2版）
    作者: Eric Matthes
    出版社: 人民邮电出版社
    年份: 2023
    语言: 中文
    页数: 512
    文件大小: 9.5 MB
    ID: 1234568
    Hash: def456

────────────────────────────────────────────────────────────────────────────────────────────────────

────────────────────────────────────────────────────────────────────────────────────────────────────
搜索条件: 书名: 深度学习 | 作者: Ian Goodfellow | 出版社: 人民邮电出版社
────────────────────────────────────────────────────────────────────────────────────────────────────
找到 1 个可下载的EPUB版本:

  【版本 1】
    书名: 深度学习
    作者: Ian Goodfellow
    出版社: 人民邮电出版社
    年份: 2017
    语言: 中文
    页数: 750
    文件大小: 25.3 MB
    ID: 7654321
    Hash: xyz789

────────────────────────────────────────────────────────────────────────────────────────────────────


====================================================================================================
【未找到的书籍列表】
====================================================================================================

1. 书名: 二战全史
   作者: 白虹
   出版社: 中国华侨出版社
   原因: 未找到可下载的EPUB格式

====================================================================================================
搜索完成
====================================================================================================
```

### 单本搜索示例

## API 方法列表

| 方法 | 说明 |
|------|------|
| `search()` | 搜索书籍 |
| `getBookInfo()` | 获取书籍详情 |
| `downloadBook()` | 下载书籍 |
| `getProfile()` | 获取用户资料 |
| `getDownloadsLeft()` | 获取剩余下载次数 |
| `getMostPopular()` | 获取热门书籍 |
| `getRecently()` | 获取最近书籍 |

## 注意事项

- 需要 [1lib.sk](https://1lib.sk) 的有效账号
- 免费账号每日下载次数有限制
- 请遵守Zlibrary的使用条款
- 建议使用Remix Token登录，更稳定

## 依赖

- Python 3.6+
- requests 库

安装依赖：
```bash
pip install requests
```

## 许可证

MIT License
# zlib_download
