# 智能约束搜索策略 - 功能说明

## 概述

批量搜索工具现在使用智能约束策略，逐步缩小搜索范围，确保找到最准确的书籍。

## 搜索策略

### 三步约束流程

```
步骤1: 仅书名搜索
  ├─ 找到0本 → 尝试加入出版社
  ├─ 找到1本 → 返回结果（唯一匹配）
  └─ 找到多本 → 继续步骤2

步骤2: 书名 + 出版社
  ├─ 找到0本 → 回退到步骤1结果
  ├─ 找到1本 → 返回结果（唯一匹配）
  └─ 找到多本 → 继续步骤3

步骤3: 书名 + 出版社 + 作者
  ├─ 找到0本 → 回退到步骤2结果
  └─ 返回最终结果
```

## 实际案例

### 案例1: 精确匹配（步骤1）

**搜索条件**: "深度学习"

**策略执行**:
```
步骤1 - 仅书名搜索: '深度学习' -> 找到 1 本EPUB
仅书名 - 唯一结果
```

**结果**: 找到1本，直接返回

---

### 案例2: 多版本书籍（步骤1-3）

**搜索条件**: "Python编程", 作者: "Eric Matthes", 出版社: "人民邮电出版社"

**策略执行**:
```
步骤1 - 仅书名搜索: 'Python编程' -> 找到 2 本EPUB
步骤2 - 书名+出版社: 'Python编程 人民邮电出版社' -> 找到 2 本EPUB
步骤3 - 完整条件: 'Python编程 Eric Matthes 人民邮电出版社' -> 找到 2 本EPUB
```

**结果**: 返回2个版本（因为同一个作者确实有多个版本的书籍）

**输出示例**:
```
【已找到的书籍列表】
────────────────────────────────────────────────────────────────────────────────────────────────────
搜索条件: 书名: Python编程 | 作者: Eric Matthes | 出版社: 人民邮电出版社
────────────────────────────────────────────────────────────────────────────────────────────────────

搜索策略:
  步骤1 - 仅书名搜索: 'Python编程' -> 找到 2 本EPUB
  步骤2 - 书名+出版社: 'Python编程 人民邮电出版社' -> 找到 2 本EPUB
  步骤3 - 完整条件: 'Python编程 Eric Matthes 人民邮电出版社' -> 找到 2 本EPUB

找到 2 个可下载的EPUB版本:

  【版本 1】
    书名: Python编程：从入门到实践
    年份: 2020
    文件大小: 8.2 MB

  【版本 2】
    书名: Python编程：从入门到实践（第2版）
    年份: 2023
    文件大小: 9.5 MB
```

---

### 案例3: 回退机制

**搜索条件**: "二战全史", 作者: "白虹", 出版社: "中国华侨出版社"

**策略执行**:
```
步骤1 - 仅书名搜索: '二战全史' -> 找到 0 本EPUB
步骤1无结果，尝试加入出版社
步骤2 - 书名+出版社: '二战全史 中国华侨出版社' -> 找到 0 本EPUB
步骤2无结果，回退到步骤1
步骤3 - 完整条件: '二战全史 白虹 中国华侨出版社' -> 找到 0 本EPUB
步骤3无结果，回退到步骤2
```

**结果**: 未找到，归类到"未找到"列表

---

### 案例4: 自动回退保护

**假设场景**:
- 步骤1找到5本书
- 步骤2（加入出版社）找到0本书

**策略执行**:
```
步骤1 - 仅书名搜索: '书名' -> 找到 5 本EPUB
步骤2 - 书名+出版社: '书名 出版社' -> 找到 0 本EPUB
步骤2无结果，回退到步骤1
```

**结果**: 返回步骤1的5本书，而不是空结果

## 策略优势

### 1. 精确性
- 逐步缩小范围，避免一次性搜索条件过严导致遗漏
- 优先使用宽泛条件，逐步收紧

### 2. 智能回退
- 如果约束过严导致无结果，自动回退到上一步
- 避免因拼写错误或版本差异而漏掉书籍

### 3. 透明性
- 每次搜索都记录完整策略
- 在输出文件中显示每一步的搜索过程

### 4. 灵活性
- 适应不同书籍的可用性
- 对于单版本书籍快速返回
- 对于多版本书籍提供完整列表

## 输出格式

在 `list.txt` 输出文件中，每个找到的书籍都会显示搜索策略：

```
────────────────────────────────────────────────────────────────────────────────────────────────────
搜索条件: 书名: Python编程 | 作者: Eric Matthes | 出版社: 人民邮电出版社
────────────────────────────────────────────────────────────────────────────────────────────────────

搜索策略:
  步骤1 - 仅书名搜索: 'Python编程' -> 找到 2 本EPUB
  步骤2 - 书名+出版社: 'Python编程 人民邮电出版社' -> 找到 2 本EPUB
  步骤3 - 完整条件: 'Python编程 Eric Matthes 人民邮电出版社' -> 找到 2 本EPUB

找到 2 个可下载的EPUB版本:
  ...
```

## 使用方法

### 正常使用（需要网络）

```bash
python batch_search.py 1.txt
```

### 模拟测试（无需网络）

```bash
python batch_search_mock_strategy.py sample_input.txt
```

## 代码实现

核心函数：
- `search_epub_books_with_strategy()` - 实现智能约束策略
- `search_books_by_condition()` - 按条件搜索
- `is_epub_available()` - 检查EPUB格式
- `get_epub_book_details()` - 获取书籍详情

详细代码见 `batch_search.py` 文件。
